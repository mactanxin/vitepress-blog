# è‡ªå·±åŠ¨æ‰‹ç³»åˆ—ä¹‹: æ‰‹å†™ä¸€ä¸ªMVVM (Part 1)
*å¦‚ä½•å®ç°åŒå‘ç»‘å®šmvvm*

> æœ¬æ–‡ä¸»è¦åšä»€ä¹ˆï¼Ÿ
> 1. äº†è§£vueçš„åŒå‘æ•°æ®ç»‘å®šåŸç†ä»¥åŠæ ¸å¿ƒä»£ç æ¨¡å—
> 2. äº†è§£å¦‚ä½•å®ç°åŒå‘ç»‘å®š
> ä¸ºäº†ä¾¿äºè¯´æ˜åŸç†ä¸å®ç°ï¼Œæœ¬æ–‡ç›¸å…³ä»£ç ä¸»è¦æ‘˜è‡ª [vueæºç ](https://github.com/vuejs/vue) , å¹¶è¿›è¡Œäº†ç®€åŒ–æ”¹é€ ï¼Œç›¸å¯¹è¾ƒç®€é™‹ï¼Œå¹¶æœªè€ƒè™‘åˆ°æ•°ç»„çš„å¤„ç†ã€æ•°æ®çš„å¾ªç¯ä¾èµ–ç­‰ï¼Œä¹Ÿéš¾å…å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæ¬¢è¿å¤§å®¶æŒ‡æ­£ã€‚ä¸è¿‡è¿™äº›å¹¶ä¸ä¼šå½±å“å¤§å®¶çš„é˜…è¯»å’Œç†è§£ï¼Œç›¸ä¿¡çœ‹å®Œæœ¬æ–‡åå¯¹å¤§å®¶åœ¨é˜…è¯»vueæºç çš„æ—¶å€™ä¼šæ›´æœ‰å¸®åŠ©

*å‡ ç§å®ç°åŒå‘ç»‘å®šçš„åšæ³•*  
ç›®å‰å‡ ç§ä¸»æµçš„mvc(vm)æ¡†æ¶éƒ½å®ç°äº†å•å‘æ•°æ®ç»‘å®šï¼Œè€Œæˆ‘æ‰€ç†è§£çš„åŒå‘æ•°æ®ç»‘å®šæ— éå°±æ˜¯åœ¨å•å‘ç»‘å®šçš„åŸºç¡€ä¸Šç»™å¯è¾“å…¥å…ƒç´ ï¼ˆinputã€textareç­‰ï¼‰æ·»åŠ äº†change(input)äº‹ä»¶ï¼Œæ¥åŠ¨æ€ä¿®æ”¹modelå’Œ viewï¼Œå¹¶æ²¡æœ‰å¤šé«˜æ·±ã€‚æ‰€ä»¥æ— éœ€å¤ªè¿‡ä»‹æ€€æ˜¯å®ç°çš„å•å‘æˆ–åŒå‘ç»‘å®šã€‚

å®ç°æ•°æ®ç»‘å®šçš„åšæ³•æœ‰å¤§è‡´å¦‚ä¸‹å‡ ç§ï¼š
1. å‘å¸ƒè€…-è®¢é˜…è€…æ¨¡å¼ï¼ˆbackbone.jsï¼‰
2. è„å€¼æ£€æŸ¥ï¼ˆangular.jsï¼‰
3. æ•°æ®åŠ«æŒï¼ˆvue.jsï¼‰

*å‘å¸ƒè€…-è®¢é˜…è€…æ¨¡å¼* :   
ä¸€èˆ¬é€šè¿‡sub, pubçš„æ–¹å¼å®ç°æ•°æ®å’Œè§†å›¾çš„ç»‘å®šç›‘å¬ï¼Œæ›´æ–°æ•°æ®æ–¹å¼é€šå¸¸åšæ³•æ˜¯ vm.set('property', value)ï¼Œè¿™é‡Œæœ‰ç¯‡æ–‡ç« è®²çš„æ¯”è¾ƒè¯¦ç»†ï¼Œæœ‰å…´è¶£å¯ç‚¹[è¿™é‡Œ](http://www.html-js.com/article/Study-of-twoway-data-binding-JavaScript-talk-about-JavaScript-every-day)

è¿™ç§æ–¹å¼ç°åœ¨æ¯•ç«Ÿå¤ªlowäº†ï¼Œæˆ‘ä»¬æ›´å¸Œæœ›é€šè¿‡ vm.property = value è¿™ç§æ–¹å¼æ›´æ–°æ•°æ®ï¼ŒåŒæ—¶è‡ªåŠ¨æ›´æ–°è§†å›¾ï¼Œäºæ˜¯æœ‰äº†ä¸‹é¢ä¸¤ç§æ–¹å¼

*è„å€¼æ£€æŸ¥* :   
angular.js æ˜¯é€šè¿‡è„å€¼æ£€æµ‹çš„æ–¹å¼æ¯”å¯¹æ•°æ®æ˜¯å¦æœ‰å˜æ›´ï¼Œæ¥å†³å®šæ˜¯å¦æ›´æ–°è§†å›¾ï¼Œæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯é€šè¿‡ setInterval() å®šæ—¶è½®è¯¢æ£€æµ‹æ•°æ®å˜åŠ¨ï¼Œå½“ç„¶Googleä¸ä¼šè¿™ä¹ˆlowï¼Œangularåªæœ‰åœ¨æŒ‡å®šçš„äº‹ä»¶è§¦å‘æ—¶è¿›å…¥è„å€¼æ£€æµ‹ï¼Œå¤§è‡´å¦‚ä¸‹:  

> DOMäº‹ä»¶ï¼Œè­¬å¦‚ç”¨æˆ·è¾“å…¥æ–‡æœ¬ï¼Œç‚¹å‡»æŒ‰é’®ç­‰ã€‚( ng-click )
> XHRå“åº”äº‹ä»¶ ( $http )
> æµè§ˆå™¨Locationå˜æ›´äº‹ä»¶ ( $location )
> Timeräº‹ä»¶( $timeout , $interval )
> æ‰§è¡Œ $digest() æˆ– $apply()

æ•°æ®åŠ«æŒ: vue.js åˆ™æ˜¯é‡‡ç”¨æ•°æ®åŠ«æŒç»“åˆå‘å¸ƒè€…-è®¢é˜…è€…æ¨¡å¼çš„æ–¹å¼ï¼Œé€šè¿‡Object.defineProperty()æ¥åŠ«æŒå„ä¸ªå±æ€§çš„setterï¼Œgetterï¼Œåœ¨æ•°æ®å˜åŠ¨æ—¶å‘å¸ƒæ¶ˆæ¯ç»™è®¢é˜…è€…ï¼Œè§¦å‘ç›¸åº”çš„ç›‘å¬å›è°ƒã€‚  

æ€è·¯æ•´ç†
å·²ç»äº†è§£åˆ°vueæ˜¯é€šè¿‡æ•°æ®åŠ«æŒçš„æ–¹å¼æ¥åšæ•°æ®ç»‘å®šçš„ï¼Œå…¶ä¸­æœ€æ ¸å¿ƒçš„æ–¹æ³•ä¾¿æ˜¯é€šè¿‡Object.defineProperty()æ¥å®ç°å¯¹å±æ€§çš„åŠ«æŒï¼Œè¾¾åˆ°ç›‘å¬æ•°æ®å˜åŠ¨çš„ç›®çš„ï¼Œæ— ç–‘è¿™ä¸ªæ–¹æ³•æ˜¯æœ¬æ–‡ä¸­æœ€é‡è¦ã€æœ€åŸºç¡€çš„å†…å®¹ä¹‹ä¸€ï¼Œå¦‚æœä¸ç†Ÿæ‚‰definePropertyï¼ŒçŒ›æˆ³è¿™é‡Œ æ•´ç†äº†ä¸€ä¸‹ï¼Œè¦å®ç°mvvmçš„åŒå‘ç»‘å®šï¼Œå°±å¿…é¡»è¦å®ç°ä»¥ä¸‹å‡ ç‚¹ï¼š 
> å®ç°ä¸€ä¸ªæ•°æ®ç›‘å¬å™¨Observerï¼Œèƒ½å¤Ÿå¯¹æ•°æ®å¯¹è±¡çš„æ‰€æœ‰å±æ€§è¿›è¡Œç›‘å¬ï¼Œå¦‚æœ‰å˜åŠ¨å¯æ‹¿åˆ°æœ€æ–°å€¼å¹¶é€šçŸ¥è®¢é˜…è€…  
> å®ç°ä¸€ä¸ªæŒ‡ä»¤è§£æå™¨Compileï¼Œå¯¹æ¯ä¸ªå…ƒç´ èŠ‚ç‚¹çš„æŒ‡ä»¤è¿›è¡Œæ‰«æå’Œè§£æï¼Œæ ¹æ®æŒ‡ä»¤æ¨¡æ¿æ›¿æ¢æ•°æ®ï¼Œä»¥åŠç»‘å®šç›¸åº”çš„æ›´æ–°å‡½æ•°   
> å®ç°ä¸€ä¸ªWatcherï¼Œä½œä¸ºè¿æ¥Observerå’ŒCompileçš„æ¡¥æ¢ï¼Œèƒ½å¤Ÿè®¢é˜…å¹¶æ”¶åˆ°æ¯ä¸ªå±æ€§å˜åŠ¨çš„é€šçŸ¥ï¼Œæ‰§è¡ŒæŒ‡ä»¤ç»‘å®šçš„ç›¸åº”å›è°ƒå‡½æ•°ï¼Œä»è€Œæ›´æ–°è§†å›¾ 4ã€mvvmå…¥å£å‡½æ•°ï¼Œæ•´åˆä»¥ä¸Šä¸‰è€…. 

<!-- [![ç¤ºä¾‹](https://raw.githubusercontent.com/mactanxin/xin-vue-blog/master/src/statics/images/mvvm.png)](https://tanx.in/2020/vue-mvvm/) -->

![ç¤ºä¾‹](https://raw.githubusercontent.com/mactanxin/xin-vue-blog/master/src/statics/images/mvvm.png "")

```javascript
let data = { name: 'Xin' };
observe(data);

// æ­¤æ—¶ç›‘å¬åˆ°æ•°æ®å˜åŒ–ğŸ‘‡
data.name = 'Wow, awesome';


function observe(data) {
  if (!data || typeof data !== 'object') return;

  // éå†
  Object.keys(data).forEach(function(key) {
    defineReactive(data, key, data[key]);
  })
};

function defineReactive(data, key, val) {
  observe(val);
  Object.defineProperty(data, key, {
    enumerable: true,
    configurable: false, //ä¸èƒ½å†æ¬¡define
    get: function () {
      return val;
    },
    set: function (newVal) {
      val = newVal;
    }
  })
}
```

è¿™æ ·æˆ‘ä»¬å·²ç»å¯ä»¥ç›‘å¬æ¯ä¸ªæ•°æ®çš„å˜åŒ–äº†ï¼Œé‚£ä¹ˆç›‘å¬åˆ°å˜åŒ–ä¹‹åå°±æ˜¯æ€ä¹ˆé€šçŸ¥è®¢é˜…è€…äº†ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªæ¶ˆæ¯è®¢é˜…å™¨ï¼Œå¾ˆç®€å•ï¼Œç»´æŠ¤ä¸€ä¸ªæ•°ç»„ï¼Œç”¨æ¥æ”¶é›†è®¢é˜…è€…ï¼Œæ•°æ®å˜åŠ¨è§¦å‘notifyï¼Œ  
å†è°ƒç”¨è®¢é˜…è€…çš„updateæ–¹æ³•.  

æ›´æ–°ä¹‹åçš„ä»£ç æ ·ä¾‹ğŸ‘‡:  

```javascript
function defineReactive(data, key, val) {
    var dep = new Dep();
    observe(val); // ç›‘å¬å­å±æ€§

    Object.defineProperty(data, key, {
        // ... çœç•¥
        set: function(newVal) {
          if (val === newVal) return;
            console.log('å“ˆå“ˆå“ˆï¼Œç›‘å¬åˆ°å€¼å˜åŒ–äº† ', val, ' --> ', newVal);
            val = newVal;
            dep.notify(); // é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…
        }
    });
}

function Dep() {
    this.subs = [];
}
Dep.prototype = {
    addSub: function(sub) {
        this.subs.push(sub);
    },
    notify: function() {
        this.subs.forEach(function(sub) {
            sub.update();
        });
    }
};
```

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè°æ˜¯è®¢é˜…è€…ï¼Ÿæ€ä¹ˆå¾€è®¢é˜…å™¨æ·»åŠ è®¢é˜…è€…ï¼Ÿ æ²¡é”™ï¼Œä¸Šé¢çš„æ€è·¯æ•´ç†ä¸­æˆ‘ä»¬å·²ç»æ˜ç¡®è®¢é˜…è€…åº”è¯¥æ˜¯`Watcher`, è€Œä¸”
`var dep = new Dep();` æ˜¯åœ¨ defineReactiveæ–¹æ³•å†…éƒ¨å®šä¹‰çš„ï¼Œ  
æ‰€ä»¥æƒ³é€šè¿‡depæ·»åŠ è®¢é˜…è€…ï¼Œå°±å¿…é¡»è¦åœ¨é—­åŒ…å†…æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨`getter`é‡Œé¢åŠ¨æ‰‹è„šï¼š


```javascript
// Observer.js
Object.defineProperty(data, key, {
  get: function() {
    // ç”±äºéœ€è¦åœ¨é—­åŒ…å†…æ·»åŠ watcherï¼Œæ‰€ä»¥é€šè¿‡Depå®šä¹‰ä¸€ä¸ªå…¨å±€targetå±æ€§ï¼Œæš‚å­˜watcher, æ·»åŠ å®Œç§»é™¤
    Dep.target && dep.addDep(Dep.target);
    return val;
  }
});

// å®ç° Watcher.js

Watcher.prototype = {
  get: function (key) {
    Dep.target = this;
    this.value = data[key];
    Dep.target = null;
  }
}
```


è¿™é‡Œå·²ç»å®ç°äº†ä¸€ä¸ªObserveräº†ï¼Œå·²ç»å…·å¤‡äº†ç›‘å¬æ•°æ®å’Œæ•°æ®å˜åŒ–é€šçŸ¥è®¢é˜…è€…çš„åŠŸèƒ½. 